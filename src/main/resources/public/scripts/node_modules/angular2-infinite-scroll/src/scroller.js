"use strict";
var Observable_1 = require('rxjs/Observable');
require('rxjs/add/observable/fromEvent');
require('rxjs/add/observable/timer');
require('rxjs/add/operator/debounce');
require('rxjs/add/operator/throttle');
require('rxjs/add/operator/filter');
require('rxjs/add/operator/delay');
;
var Scroller = (function () {
    function Scroller(windowElement, $interval, $elementRef, infiniteScrollDownCallback, infiniteScrollUpCallback, infiniteScrollDownDistance, infiniteScrollUpDistance, infiniteScrollParent, infiniteScrollThrottle, isImmediate, horizontal, alwaysCallback, scrollDisabled, _positionResolver, throttleType) {
        if (horizontal === void 0) { horizontal = false; }
        if (alwaysCallback === void 0) { alwaysCallback = false; }
        if (scrollDisabled === void 0) { scrollDisabled = false; }
        if (throttleType === void 0) { throttleType = 'throttle'; }
        this.windowElement = windowElement;
        this.$interval = $interval;
        this.$elementRef = $elementRef;
        this.infiniteScrollDownCallback = infiniteScrollDownCallback;
        this.infiniteScrollUpCallback = infiniteScrollUpCallback;
        this.infiniteScrollThrottle = infiniteScrollThrottle;
        this.isImmediate = isImmediate;
        this.horizontal = horizontal;
        this.alwaysCallback = alwaysCallback;
        this.scrollDisabled = scrollDisabled;
        this._positionResolver = _positionResolver;
        this.throttleType = throttleType;
        this.lastScrollPosition = 0;
        this.isContainerWindow = Object.prototype.toString.call(this.windowElement).includes('Window');
        this.documentElement = this.isContainerWindow ? this.windowElement.document.documentElement : null;
        this.handleInfiniteScrollDistance(infiniteScrollDownDistance, infiniteScrollUpDistance);
        // if (attrs.infiniteScrollParent != null) {
        // 	attachEvent(angular.element(elem.parent()));
        // }
        this.handleInfiniteScrollDisabled(scrollDisabled);
        this.defineContainer();
        this.positionResolver = this._positionResolver.create({
            container: this.container,
            documentElement: this.documentElement,
            isContainerWindow: this.isContainerWindow,
            horizontal: horizontal
        });
        this.createInterval();
    }
    Scroller.prototype.defineContainer = function () {
        if (this.isContainerWindow) {
            this.container = this.windowElement;
        }
        else {
            this.container = this.windowElement.nativeElement;
        }
        this.attachEvent(this.container);
    };
    Scroller.prototype.createInterval = function () {
        var _this = this;
        if (this.isImmediate) {
            this.checkInterval = this.$interval(function () {
                return _this.handler();
            }, 0);
        }
    };
    Scroller.prototype.handler = function () {
        var _this = this;
        var container = this.positionResolver.calculatePoints(this.$elementRef);
        var scrollingDown = this.lastScrollPosition < container.scrolledUntilNow;
        this.lastScrollPosition = container.scrolledUntilNow;
        var remaining;
        var containerBreakpoint;
        if (scrollingDown) {
            remaining = container.totalToScroll - container.scrolledUntilNow;
            containerBreakpoint = container.height * this.scrollDownDistance + 1;
        }
        else {
            remaining = container.scrolledUntilNow;
            containerBreakpoint = container.height * this.scrollUpDistance + 1;
        }
        var shouldScroll = remaining <= containerBreakpoint;
        var triggerCallback = (this.alwaysCallback || shouldScroll) && this.scrollEnabled;
        var shouldClearInterval = !shouldScroll && this.checkInterval;
        // if (this.useDocumentBottom) {
        // 	container.totalToScroll = this.height(this.$elementRef.nativeElement.ownerDocument);
        // }
        this.checkWhenEnabled = shouldScroll;
        if (triggerCallback) {
            var infiniteScrollEvent = {
                currentScrollPosition: container.scrolledUntilNow
            };
            if (scrollingDown) {
                this.infiniteScrollDownCallback(infiniteScrollEvent);
            }
            else {
                this.infiniteScrollUpCallback(infiniteScrollEvent);
            }
        }
        if (shouldClearInterval) {
            clearInterval(this.checkInterval);
        }
        setTimeout(function () {
            var container = _this.positionResolver.calculatePoints(_this.$elementRef);
            if (container.scrolledUntilNow >= container.totalToScroll) {
                _this.handler();
            }
        }, this.infiniteScrollThrottle);
    };
    Scroller.prototype.handleInfiniteScrollDistance = function (scrollDownDistance, scrollUpDistance) {
        this.scrollDownDistance = parseFloat(scrollDownDistance) || 0;
        this.scrollUpDistance = parseFloat(scrollUpDistance) || 0;
    };
    Scroller.prototype.attachEvent = function (newContainer) {
        var _this = this;
        this.clean();
        if (newContainer) {
            var throttle_1 = this.infiniteScrollThrottle;
            this.disposeScroll = Observable_1.Observable.fromEvent(this.container, 'scroll')[this.throttleType](function () { return Observable_1.Observable.timer(throttle_1); })
                .filter(function () { return _this.scrollEnabled; })
                .subscribe(function () { return _this.handler(); });
        }
    };
    Scroller.prototype.clean = function () {
        if (this.disposeScroll) {
            this.disposeScroll.unsubscribe();
        }
    };
    Scroller.prototype.handleInfiniteScrollDisabled = function (scrollDisabled) {
        this.scrollEnabled = !scrollDisabled;
    };
    return Scroller;
}());
exports.Scroller = Scroller;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoic2Nyb2xsZXIuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyJzY3JvbGxlci50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiO0FBQ0EsMkJBQTJCLGlCQUFpQixDQUFDLENBQUE7QUFJN0MsUUFBTywrQkFBK0IsQ0FBQyxDQUFBO0FBQ3ZDLFFBQU8sMkJBQTJCLENBQUMsQ0FBQTtBQUNuQyxRQUFPLDRCQUE0QixDQUFDLENBQUE7QUFDcEMsUUFBTyw0QkFBNEIsQ0FBQyxDQUFBO0FBQ3BDLFFBQU8sMEJBQTBCLENBQUMsQ0FBQTtBQUNsQyxRQUFPLHlCQUF5QixDQUFDLENBQUE7QUFJaEMsQ0FBQztBQUVGO0lBZ0JFLGtCQUNVLGFBQXdDLEVBQ3hDLFNBQW1CLEVBQ25CLFdBQXVCLEVBQ3ZCLDBCQUFvQyxFQUNwQyx3QkFBa0MsRUFDMUMsMEJBQWtDLEVBQ2xDLHdCQUFnQyxFQUNoQyxvQkFBK0MsRUFDdkMsc0JBQThCLEVBQzlCLFdBQW9CLEVBQ3BCLFVBQTJCLEVBQzNCLGNBQStCLEVBQy9CLGNBQStCLEVBQy9CLGlCQUEwQyxFQUMxQyxZQUFpQztRQUp6QywwQkFBbUMsR0FBbkMsa0JBQW1DO1FBQ25DLDhCQUF1QyxHQUF2QyxzQkFBdUM7UUFDdkMsOEJBQXVDLEdBQXZDLHNCQUF1QztRQUV2Qyw0QkFBeUMsR0FBekMseUJBQXlDO1FBZGpDLGtCQUFhLEdBQWIsYUFBYSxDQUEyQjtRQUN4QyxjQUFTLEdBQVQsU0FBUyxDQUFVO1FBQ25CLGdCQUFXLEdBQVgsV0FBVyxDQUFZO1FBQ3ZCLCtCQUEwQixHQUExQiwwQkFBMEIsQ0FBVTtRQUNwQyw2QkFBd0IsR0FBeEIsd0JBQXdCLENBQVU7UUFJbEMsMkJBQXNCLEdBQXRCLHNCQUFzQixDQUFRO1FBQzlCLGdCQUFXLEdBQVgsV0FBVyxDQUFTO1FBQ3BCLGVBQVUsR0FBVixVQUFVLENBQWlCO1FBQzNCLG1CQUFjLEdBQWQsY0FBYyxDQUFpQjtRQUMvQixtQkFBYyxHQUFkLGNBQWMsQ0FBaUI7UUFDL0Is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Y2VzQ29udGVudCI6WyJpbXBvcnQgeyBFbGVtZW50UmVmIH0gZnJvbSAnQGFuZ3VsYXIvY29yZSc7XG5pbXBvcnQgeyBPYnNlcnZhYmxlIH0gZnJvbSAncnhqcy9PYnNlcnZhYmxlJztcbmltcG9ydCB7IFN1YnNjcmlwdGlvbiB9IGZyb20gJ3J4anMvU3Vic2NyaXB0aW9uJztcbmltcG9ydCB7IEF4aXNSZXNvbHZlciB9IGZyb20gJy4vYXhpcy1yZXNvbHZlcic7XG5pbXBvcnQgeyBQb3NpdGlvblJlc29sdmVyLCBQb3NpdGlvblJlc29sdmVyRmFjdG9yeSB9IGZyb20gJy4vcG9zaXRpb24tcmVzb2x2ZXInO1xuaW1wb3J0ICdyeGpzL2FkZC9vYnNlcnZhYmxlL2Zyb21FdmVudCc7XG5pbXBvcnQgJ3J4anMvYWRkL29ic2VydmFibGUvdGltZXInO1xuaW1wb3J0ICdyeGpzL2FkZC9vcGVyYXRvci9kZWJvdW5jZSc7XG5pbXBvcnQgJ3J4anMvYWRkL29wZXJhdG9yL3Rocm90dGxlJztcbmltcG9ydCAncnhqcy9hZGQvb3BlcmF0b3IvZmlsdGVyJztcbmltcG9ydCAncnhqcy9hZGQvb3BlcmF0b3IvZGVsYXknO1xuXG5leHBvcnQgaW50ZXJmYWNlIEluZmluaXRlU2Nyb2xsRXZlbnQge1xuICBjdXJyZW50U2Nyb2xsUG9zaXRpb246IG51bWJlcjtcbn07XG5cbmV4cG9ydCBjbGFzcyBTY3JvbGxlciB7XG4gIHB1YmxpYyBzY3JvbGxEb3duRGlzdGFuY2U6IG51bWJlcjtcbiAgcHVibGljIHNjcm9sbFVwRGlzdGFuY2U6IG51bWJlcjtcbiAgcHVibGljIHNjcm9sbEVuYWJsZWQ6IGJvb2xlYW47XG4gIHB1YmxpYyBjaGVja1doZW5FbmFibGVkOiBib29sZWFuO1xuICBwdWJsaWMgY29udGFpbmVyOiBXaW5kb3cgfCBFbGVtZW50UmVmIHwgYW55O1xuICBwdWJsaWMgaW1tZWRpYXRlQ2hlY2s6IGJvb2xlYW47XG4gIHB1YmxpYyB1c2VEb2N1bWVudEJvdHRvbTogYm9vbGVhbjtcbiAgcHVibGljIGNoZWNrSW50ZXJ2YWw6IG51bWJlcjtcbiAgcHJpdmF0ZSBkb2N1bWVudEVsZW1lbnQ6IFdpbmRvdyB8IEVsZW1lbnRSZWYgfCBhbnk7XG4gIHByaXZhdGUgaXNDb250YWluZXJXaW5kb3c6IGJvb2xlYW47XG4gIHByaXZhdGUgZGlzcG9zZVNjcm9sbDogU3Vic2NyaXB0aW9uO1xuICBwdWJsaWMgbGFzdFNjcm9sbFBvc2l0aW9uOiBudW1iZXIgPSAwO1xuICAvLyBwcml2YXRlIGF4aXM6IEF4aXNSZXNvbHZlcjtcbiAgcHJpdmF0ZSBwb3NpdGlvblJlc29sdmVyOiBQb3NpdGlvblJlc29sdmVyO1xuXG4gIGNvbnN0cnVjdG9yKFxuICAgIHByaXZhdGUgd2luZG93RWxlbWVudDogV2luZG93IHwgRWxlbWVudFJlZiB8IGFueSxcbiAgICBwcml2YXRlICRpbnRlcnZhbDogRnVuY3Rpb24sXG4gICAgcHJpdmF0ZSAkZWxlbWVudFJlZjogRWxlbWVudFJlZixcbiAgICBwcml2YXRlIGluZmluaXRlU2Nyb2xsRG93bkNhbGxiYWNrOiBGdW5jdGlvbixcbiAgICBwcml2YXRlIGluZmluaXRlU2Nyb2xsVXBDYWxsYmFjazogRnVuY3Rpb24sXG4gICAgaW5maW5pdGVTY3JvbGxEb3duRGlzdGFuY2U6IG51bWJlcixcbiAgICBpbmZpbml0ZVNjcm9sbFVwRGlzdGFuY2U6IG51bWJlcixcbiAgICBpbmZpbml0ZVNjcm9sbFBhcmVudDogV2luZG93IHwgRWxlbWVudFJlZiB8IGFueSxcbiAgICBwcml2YXRlIGluZmluaXRlU2Nyb2xsVGhyb3R0bGU6IG51bWJlcixcbiAgICBwcml2YXRlIGlzSW1tZWRpYXRlOiBib29sZWFuLFxuICAgIHByaXZhdGUgaG9yaXpvbnRhbDogYm9vbGVhbiA9IGZhbHNlLFxuICAgIHByaXZhdGUgYWx3YXlzQ2FsbGJhY2s6IGJvb2xlYW4gPSBmYWxzZSxcbiAgICBwcml2YXRlIHNjcm9sbERpc2FibGVkOiBib29sZWFuID0gZmFsc2UsXG4gICAgcHJpdmF0ZSBfcG9zaXRpb25SZXNvbHZlcjogUG9zaXRpb25SZXNvbHZlckZhY3RvcnksXG4gICAgcHJpdmF0ZSB0aHJvdHRsZVR5cGU6IHN0cmluZyA9ICd0aHJvdHRsZSdcbiAgKSB7XG4gICAgdGhpcy5pc0NvbnRhaW5lcldpbmRvdyA9IE9iamVjdC5wcm90b3R5cGUudG9TdHJpbmcuY2FsbCh0aGlzLndpbmRvd0VsZW1lbnQpLmluY2x1ZGVzKCdXaW5kb3cnKTtcbiAgICB0aGlzLmRvY3VtZW50RWxlbWVudCA9IHRoaXMuaXNDb250YWluZXJXaW5kb3cgPyB0aGlzLndpbmRvd0VsZW1lbnQuZG9jdW1lbnQuZG9jdW1lbnRFbGVtZW50IDogbnVsbDtcbiAgICB0aGlzLmhhbmRsZUluZmluaXRlU2Nyb2xsRGlzdGFuY2UoaW5maW5pdGVTY3JvbGxEb3duRGlzdGFuY2UsIGluZmluaXRlU2Nyb2xsVXBEaXN0YW5jZSk7XG5cbiAgICAvLyBpZiAoYXR0cnMuaW5maW5pdGVTY3JvbGxQYXJlbnQgIT0gbnVsbCkge1xuICAgIC8vIFx0YXR0YWNoRXZlbnQoYW5ndWxhci5lbGVtZW50KGVsZW0ucGFyZW50KCkpKTtcbiAgICAvLyB9XG4gICAgdGhpcy5oYW5kbGVJbmZpbml0ZVNjcm9sbERpc2FibGVkKHNjcm9sbERpc2FibGVkKTtcbiAgICB0aGlzLmRlZmluZUNvbnRhaW5lcigpO1xuICAgIHRoaXMucG9zaXRpb25SZXNvbHZlciA9IHRoaXMuX3Bvc2l0aW9uUmVzb2x2ZXIuY3JlYXRlKHtcbiAgICAgIGNvbnRhaW5lcjogdGhpcy5jb250YWluZXIsXG4gICAgICBkb2N1bWVudEVsZW1lbnQ6IHRoaXMuZG9jdW1lbnRFbGVtZW50LFxuICAgICAgaXNDb250YWluZXJXaW5kb3c6IHRoaXMuaXNDb250YWluZXJXaW5kb3csXG4gICAgICBob3Jpem9udGFsOiBob3Jpem9udGFsXG4gICAgfSk7XG5cbiAgICB0aGlzLmNyZWF0ZUludGVydmFsKCk7XG4gIH1cblxuICBkZWZpbmVDb250YWluZXIgKCkge1xuICAgIGlmICh0aGlzLmlzQ29udGFpbmVyV2luZG93KSB7XG4gICAgICB0aGlzLmNvbnRhaW5lciA9IHRoaXMud2luZG93RWxlbWVudDtcbiAgICB9IGVsc2Uge1xuICAgICAgdGhpcy5jb250YWluZXIgPSB0aGlzLndpbmRvd0VsZW1lbnQubmF0aXZlRWxlbWVudDtcbiAgICB9XG4gICAgdGhpcy5hdHRhY2hFdmVudCh0aGlzLmNvbnRhaW5lcik7XG4gIH1cblxuICBjcmVhdGVJbnRlcnZhbCAoKSB7XG4gICAgaWYgKHRoaXMuaXNJbW1lZGlhdGUpIHtcbiAgICAgIHRoaXMuY2hlY2tJbnRlcnZhbCA9IHRoaXMuJGludGVydmFsKCgpID0+IHtcbiAgICAgICAgcmV0dXJuIHRoaXMuaGFuZGxlcigpO1xuICAgICAgfSwgMCk7XG4gICAgfVxuICB9XG5cbiAgaGFuZGxlciAoKSB7XG4gICAgY29uc3QgY29udGFpbmVyID0gdGhpcy5wb3NpdGlvblJlc29sdmVyLmNhbGN1bGF0ZVBvaW50cyh0aGlzLiRlbGVtZW50UmVmKTtcbiAgICBjb25zdCBzY3JvbGxpbmdEb3duOiBib29sZWFuID0gdGhpcy5sYXN0U2Nyb2xsUG9zaXRpb24gPCBjb250YWluZXIuc2Nyb2xsZWRVbnRpbE5vdztcbiAgICB0aGlzLmxhc3RTY3JvbGxQb3NpdGlvbiA9IGNvbnRhaW5lci5zY3JvbGxlZFVudGlsTm93O1xuXG4gICAgbGV0IHJlbWFpbmluZzogbnVtYmVyO1xuICAgIGxldCBjb250YWluZXJCcmVha3BvaW50OiBudW1iZXI7XG4gICAgaWYgKHNjcm9sbGluZ0Rvd24pIHtcbiAgICAgIHJlbWFpbmluZyA9IGNvbnRhaW5lci50b3RhbFRvU2Nyb2xsIC0gY29udGFpbmVyLnNjcm9sbGVkVW50aWxOb3c7XG4gICAgICBjb250YWluZXJCcmVha3BvaW50ID0gY29udGFpbmVyLmhlaWdodCAqIHRoaXMuc2Nyb2xsRG93bkRpc3RhbmNlICsgMTtcbiAgICB9IGVsc2Uge1xuICAgICAgcmVtYWluaW5nID0gY29udGFpbmVyLnNjcm9sbGVkVW50aWxOb3c7XG4gICAgICBjb250YWluZXJCcmVha3BvaW50ID0gY29udGFpbmVyLmhlaWdodCAqIHRoaXMuc2Nyb2xsVXBEaXN0YW5jZSArIDE7XG4gICAgfVxuICAgIGNvbnN0IHNob3VsZFNjcm9sbDogYm9vbGVhbiA9IHJlbWFpbmluZyA8PSBjb250YWluZXJCcmVha3BvaW50O1xuICAgIGNvbnN0IHRyaWdnZXJDYWxsYmFjazogYm9vbGVhbiA9ICh0aGlzLmFsd2F5c0NhbGxiYWNrIHx8IHNob3VsZFNjcm9sbCkgJiYgdGhpcy5zY3JvbGxFbmFibGVkO1xuICAgIGNvbnN0IHNob3VsZENsZWFySW50ZXJ2YWwgPSAhc2hvdWxkU2Nyb2xsICYmIHRoaXMuY2hlY2tJbnRlcnZhbDtcbiAgICAvLyBpZiAodGhpcy51c2VEb2N1bWVudEJvdHRvbSkge1xuICAgIC8vIFx0Y29udGFpbmVyLnRvdGFsVG9TY3JvbGwgPSB0aGlzLmhlaWdodCh0aGlzLiRlbGVtZW50UmVmLm5hdGl2ZUVsZW1lbnQub3duZXJEb2N1bWVudCk7XG4gICAgLy8gfVxuICAgIHRoaXMuY2hlY2tXaGVuRW5hYmxlZCA9IHNob3VsZFNjcm9sbDtcblxuICAgIGlmICh0cmlnZ2VyQ2FsbGJhY2spIHtcbiAgICAgIGNvbnN0IGluZmluaXRlU2Nyb2xsRXZlbnQ6IEluZmluaXRlU2Nyb2xsRXZlbnQgPSB7XG4gICAgICAgIGN1cnJlbnRTY3JvbGxQb3NpdGlvbjogY29udGFpbmVyLnNjcm9sbGVkVW50aWxOb3dcbiAgICAgIH07XG4gICAgICBpZiAoc2Nyb2xsaW5nRG93bikge1xuICAgICAgICB0aGlzLmluZmluaXRlU2Nyb2xsRG93bkNhbGxiYWNrKGluZmluaXRlU2Nyb2xsRXZlbnQpO1xuICAgICAgfSBlbHNlIHtcbiAgICAgICAgdGhpcy5pbmZpbml0ZVNjcm9sbFVwQ2FsbGJhY2soaW5maW5pdGVTY3JvbGxFdmVudCk7XG4gICAgICB9XG4gICAgfVxuICAgIGlmIChzaG91bGRDbGVhckludGVydmFsKSB7XG4gICAgICBjbGVhckludGVydmFsKHRoaXMuY2hlY2tJbnRlcnZhbCk7XG4gICAgfVxuICAgIHNldFRpbWVvdXQoKCkgPT4ge1xuICAgICAgY29uc3QgY29udGFpbmVyID0gdGhpcy5wb3NpdGlvblJlc29sdmVyLmNhbGN1bGF0ZVBvaW50cyh0aGlzLiRlbGVtZW50UmVmKTtcbiAgICAgIGlmIChjb250YWluZXIuc2Nyb2xsZWRVbnRpbE5vdyA+PSBjb250YWluZXIudG90YWxUb1Njcm9sbCkge1xuICAgICAgICB0aGlzLmhhbmRsZXIoKTtcbiAgICAgIH1cbiAgICB9LCB0aGlzLmluZmluaXRlU2Nyb2xsVGhyb3R0bGUpO1xuICB9XG5cbiAgaGFuZGxlSW5maW5pdGVTY3JvbGxEaXN0YW5jZSAoc2Nyb2xsRG93bkRpc3RhbmNlOiBudW1iZXIgfCBhbnksIHNjcm9sbFVwRGlzdGFuY2U6IG51bWJlciB8IGFueSkge1xuICAgIHRoaXMuc2Nyb2xsRG93bkRpc3RhbmNlID0gcGFyc2VGbG9hdChzY3JvbGxEb3duRGlzdGFuY2UpIHx8IDA7XG4gICAgdGhpcy5zY3JvbGxVcERpc3RhbmNlID0gcGFyc2VGbG9hdChzY3JvbGxVcERpc3RhbmNlKSB8fCAwO1xuICB9XG5cbiAgYXR0YWNoRXZlbnQgKG5ld0NvbnRhaW5lcjogV2luZG93IHwgRWxlbWVudFJlZiB8IGFueSkge1xuICAgIHRoaXMuY2xlYW4oKTtcbiAgICBpZiAobmV3Q29udGFpbmVyKSB7XG4gICAgICBjb25zdCB0aHJvdHRsZTogbnVtYmVyID0gdGhpcy5pbmZpbml0ZVNjcm9sbFRocm90dGxlO1xuICAgICAgdGhpcy5kaXNwb3NlU2Nyb2xsID0gT2JzZXJ2YWJsZS5mcm9tRXZlbnQodGhpcy5jb250YWluZXIsICdzY3JvbGwnKVxuICAgICAgICBbdGhpcy50aHJvdHRsZVR5cGVdKCgpID0+IE9ic2VydmFibGUudGltZXIodGhyb3R0bGUpKVxuICAgICAgICAuZmlsdGVyKCgpID0+IHRoaXMuc2Nyb2xsRW5hYmxlZClcbiAgICAgICAgLnN1YnNjcmliZSgoKSA9PiB0aGlzLmhhbmRsZXIoKSk7XG4gICAgfVxuICB9XG5cbiAgY2xlYW4gKCkge1xuICAgIGlmICh0aGlzLmRpc3Bvc2VTY3JvbGwpIHtcbiAgICAgIHRoaXMuZGlzcG9zZVNjcm9sbC51bnN1YnNjcmliZSgpO1xuICAgIH1cbiAgfVxuXG4gIGhhbmRsZUluZmluaXRlU2Nyb2xsRGlzYWJsZWQgKHNjcm9sbERpc2FibGVkOiBib29sZWFuKSB7XG4gICAgdGhpcy5zY3JvbGxFbmFibGVkID0gIXNjcm9sbERpc2FibGVkO1xuICB9XG59XG5cbmludGVyZmFjZSBEZWNvcmF0b3JJbnZvY2F0aW9uIHtcbiAgdHlwZTogRnVuY3Rpb247XG4gIGFyZ3M/OiBhbnlbXTtcbn1cbiJdfQ==